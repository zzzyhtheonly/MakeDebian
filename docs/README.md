#  Ubuntu Desktop deb软件包制作

# 工程介绍

## 背景

基于ubuntu18.04研发桌面OS，需要制作自己的软件源并定制软件包，本工程负责对debian软件包进行定制研发，为构筑自研OS自己的软件源进行前置的离线包制作。

同时本工程旨在对于一些ubuntu源软件包通用的特性，可以离线批量对其修改并重新制作软件包，避免大量重复的制作软件包的劳动，提高研发效率。

调研ubuntu本身做包的工具，有跨平台自动编译工具、本地更新changelog工具等等，其各有优劣，比如不能离线、配置复杂、不能一键等等，在这种情况下，开发了一个本地离线可以更新并定制软件包的工具。

## 优势

使用者需要关心的只有需要编哪些源码包，并把他们放到统一的目录下；

相比于debian提供的autobuilder，省去了麻烦的配置工作，不需要开发机有网络且连接到特定软件源站点，并且增加了分类日志、支持过滤匹配替换功能；

相比于更新changelog的工具dch，操作更简洁（当然后面根据需求，也有可能直接把dch硬编码进去），对于不想使用nano等编辑器的用户更友好；

文本处理匹配替换是根据debian源码目录特定的场景定制的，相当于实现了一个简化定制版的sed工具，测试遍历一个debian目录本工具可以在ms级完成，而shell脚本使用sed和awk组合实现可能需要min级，效率极大优化；

自动判断Debian目标目录后生成多个进程去编译，实现同时编译多个包，这样可以保证在cpu富裕的情况下，编译大量包的速度约等于编一个包（除去用户输入等待时间），其实那些自动编译工具如redhat的koji只是把工作分发docker去build，本工具在离线状态下可以替代实现类似效果；

# 前置知识

相关知识均可在互联网上查阅，因此不做过多篇幅赘述，只列出概要。

## 常规deb制作方法

dpkg使用：

dpkg-deb

dpkg-buildpackage

debbuild: dpkg的封装接口

注：本工程中的自动批量编译主要使用dpkg-buildpackage实现

#### 方法一：源码包制作

获取源码：apt source xxx

修改；

编译二进制：dpkg-buildpackage -b --no-sign / dpkg-buildpackage -b -uc -us

或者用debuild，参数一样；

#### 方法二：自己的源码制作

先用dh\_make对目录进行debian包目录初始化，然后根据需求制作即可，细节可查看[https://www.debian.org/doc/manuals/maint-guide](https://www.debian.org/doc/manuals/maint-guide)

#### 方法三：系统中的deb解包制作

由于可以使用软件源，此方法并不规范，应该不需要使用此方法；

#### 常见错误与解决方案

报changelog相关错误：先检查目录对不对，再检查changelog格式对不对，使用本工程程序的话会自动更新changelog格式，应该不存在该问题，也可以用dch工具查看编辑changelog；

报上游改动相关的错误：可以加上-b选项，只编二进制；

报签名相关的错误：可以加上-uc、-us或--no-sign等选项忽略签名；

报quilt相关错误：找到debian目录下source目录下的format文件，将其中的quilt关键字改成native；

## Debian目录下重要文件

本节列出概要，详细可以在[https://www.debian.org/doc/manuals/maint-guide/](https://www.debian.org/doc/manuals/maint-guide/)查看官方文档学习；

#### control文件

包控制信息，主要就是包名和依赖关系；

#### rules文件

生成包时的控制规则脚本，由dh\_命令族构成；

#### changelog文件

按固定格式记录改动和版本号；

#### .install文件

决定deb安装后文件的解包位置；

#### 各级目录下Makefile.am文件

Makefile，不同的源码写法不同；

#### .preinst文件

安装前执行的脚本，可以自定义；

#### .postinst文件

安装后执行的脚本，可以自定义；

#### .prerm文件

卸载前执行的脚本，可以自定义；

#### .postrm文件

卸载后执行的脚本，可以自定义；

## Deb安装方法

#### 常规安装

本地：sudo dpkg -i xxx.deb

从软件源：sudo apt install xxx

#### 常见错误与解决方案

本地：

出现因改名导致重复安装的情况，可以加上—force-overwrite参数；

影响其他软件包的情况，可以加上-B参数;

出现依赖相关问题要强制安装的情况，可以加上—force-depends参数；

无法定位的时候可以直接—force-all；

软件源：

可以根据apt的提示，使用fix—broken等参数；

如果软件包已被破坏，可以purge掉再试试；

## Shell脚本编程

## Linux下C语言编程

# 支持功能

## 程序逻辑概览

1.自动从指定目录下查找debian目录；也可以指定不查找的参数，则自动递归处理所有目录，但只做文件处理，不尝试编译；

2.找到后更新changelog文件，控制台界面输入想要更改的版本号、注释；

3.根据自定规则对目录下的所有文本包括文件名进行处理（若命令行没指定则跳过这步），根据命令行参数进行过滤（跟据文件类型、正则匹配等跳过不需要处理的文件，硬编码在程序中）、匹配、替换（可以是多组，由使用者在命令行中指定）；

3.对debian目录的源码进行编译，将该Debian包的编译日志分为标准输出和错误输出分别记录；

4.若编译成功，将编译后的deb移动到指定target目录；若编译失败，回溯changelog，将该debian包名记录到失败列表日志，程序运行完后可供使用者查看；

5.返回上级目录继续查找debian目录，若有则循环执行2-4，若没有则结束程序；

## 自动判断debian目录

无论任何目录结构，即无论是多层嵌套还是有很多无效目录，程序会自动判断指定目录下的debian目录，跳过非debian目录，但也可以指定参数只做文件处理不判断debian目录；

## 多组关键字替换

支持将整个工程中要用到的所有源码中的所有对应关键字进行替换，如将所有ubuntu替换为xxxx、 Ubuntu替换为XXXX等；

替换功能包括替换文件名和替换文件内容，可以根据命令行参数只替换两者之一或全部替换；

同时保留了在debian/control目录下的maintainer等ubuntu原生相关的维护者信息，即这些信息中的关键字不会被替换，这些规则是硬编码进去的，主要是利用正则匹配；

## 按默认格式修改changelog

功能类似于dch，只不过不是直接编辑changelog而是在命令行输入；

## 将编好的deb包集中到统一的目标目录下

支持将批量编好的deb包统一放到目标目录下，方便后续打包；

输入参数若不输入目标目录，每个源码包编出来的deb包还会默认存在源码的上级目录；

## 编译日志记录

针对每个debian目录都会将标准输出和错误输出重定向到工作目录下的log目录下的两个文件，方便查看；

针对编译失败的debian目录，会把目录名记录到log/err文件中，方便定位；

## 优化

#### 根据规则匹配忽略一些文件

根据文件名进行一些过滤，直接跳过不处理，例如常见的图像音频文件格式等等；

#### 匹配规则优化

有两套匹配集，先进行简单的字符串匹配，再进行正则匹配，这样对于比较容易匹配到的字符串直接跳过正则匹配，提高效率；

#### 同时编译多个目录

父进程查找debian目录，找到后fork一个子进程去编译，实现同时编译多个debian目录，在多核下速度约等于编一个（除去用户输入等待时间）；

# 使用方法

## 准备工作

在source目录下为每一个要制作的源码包创建一个目录：mkdir xxx

进入该目录并将源码包解包后放置其中：cd xxx ; sudo apt source xxx(或其他方法)

示例source目录树结构：

├── dash-to-dock（mkdir自建源码根目录）

    ├── gnome-shell-extension-dashtodock-63（Debian源码目录）

        ├── ……

├── gnome-shell（mkdir自建源码根目录）

    ├── gnome-shell-3.28.4 (Debian源码目录)

        ├── ……

├──……

**不是必须按照上述树结构构造目录** ，工程会自动查找给定目录下的所有子目录，找到debian源码目录进行编译，只是构造成上述结构比较方便自己管理；

进入工程的src目录下make编译源码；

## 运行

必选参数：

-s 源目录

可选参数：

-t 目标目录（如不指定则直接编译到每个包的默认目录）

-i 无视debian目录处理源目录下所有文件

-a 替换处理时处理文件名和文件内容

-c 替换处理时只处理文件内容

-n 替换处理时只处理文件名

-e 更新changelog时维护者邮箱（如不指定自动更新制作者也就是我的邮箱。。）

-m 更新changelog时维护者姓名（如不指定自动更新制作者也就是我的姓名。。）

-U 不更新changelog直接编译

如选了can之一，后面可以跟任意组替换对象如ubuntu tencent（等同于sed中s/ubuntu/tencent/g）;

示例：

./MakeTencentDeb -s /source/ -t /target/ -m &quot;Yuanhan Zhang&quot; -e &quot;johnazhang@tencent.com&quot; -a ubuntu tencent

./MakeTencentDeb -s ../source/ -t ../target/ -U

## 查看结果

查看指定的目标目录，应有编好的deb；

查看源目录下的log目录，记录了编译情况；err文件查看编译失败的包名；对于每个包标准输入可查看包名\_out日志文件，标准错误可查看包名\_err日志文件；

# 后续工作

输入版本号，注释等功能界面化，考虑用gtk实现（本工具应该只用于debian ubuntu平台，不存在移植问题）；

从git上拉源，做好后在传到git上去，用python在当前c程序前后分别加一段脚本应该就行，相当于把前面的准备工作自动化，然后再把集中到目标目录的deb统一上传，等于直接取代了debian本身的那套自动编译，应该不难开发；

Verbose参数，增加个打印开关，当前打印都是硬编码进去的，也可以增加个枚举类型，或者整个perror那种机制，更规范一些；